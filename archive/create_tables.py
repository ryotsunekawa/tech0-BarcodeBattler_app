import os
import psycopg2
from dotenv import load_dotenv

# ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
load_dotenv()

def create_tables():
    """
    Supabaseã«User Base Tableã¨User_OperationsDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹
    """
    
    # Supabaseã®æ¥ç¶šæƒ…å ±ã‚’å–å¾—
    supabase_url = os.getenv("SUPABASE_URL")
    supabase_anon_key = os.getenv("SUPABASE_ANON_KEY")
    
    if not supabase_url or not supabase_anon_key:
        print("âŒ ã‚¨ãƒ©ãƒ¼: .envãƒ•ã‚¡ã‚¤ãƒ«ã«SUPABASE_URLã¨SUPABASE_ANON_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return False
    
    # PostgreSQLæ¥ç¶šç”¨ã®URLã‚’æ§‹ç¯‰
    # Supabaseã®URLã‹ã‚‰ãƒ›ã‚¹ãƒˆåã‚’æŠ½å‡º
    host = supabase_url.replace("https://", "").replace("http://", "")
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—ï¼ˆSupabaseã®å ´åˆï¼‰
    # æ³¨æ„: å®Ÿéš›ã®æ¥ç¶šã«ã¯DBç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™
    db_password = os.getenv("SUPABASE_DB_PASSWORD")  # .envã«è¿½åŠ ãŒå¿…è¦
    
    if not db_password:
        print("âŒ ã‚¨ãƒ©ãƒ¼: .envãƒ•ã‚¡ã‚¤ãƒ«ã«SUPABASE_DB_PASSWORDã‚’è¿½åŠ ã—ã¦ãã ã•ã„")
        print("   Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > Settings > Database > Connection stringã‹ã‚‰å–å¾—ã§ãã¾ã™")
        return False
    
    try:
        # PostgreSQLæ¥ç¶š
        conn = psycopg2.connect(
            host=host,
            database="postgres",
            user="postgres",
            password=db_password,
            port="5432"
        )
        
        cursor = conn.cursor()
        
        print("ğŸ”Œ Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¾ã—ãŸ")
        
        # 1. User Base Tableã®ä½œæˆ
        create_users_table = """
        CREATE TABLE IF NOT EXISTS users (
            user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            mail_address TEXT UNIQUE NOT NULL,
            user_name TEXT,
            location TEXT,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        """
        
        cursor.execute(create_users_table)
        print("âœ… usersãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ")
        
        # 2. User_OperationsDBãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
        create_operations_table = """
        CREATE TABLE IF NOT EXISTS user_operations (
            id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
            user_id UUID REFERENCES users(user_id),
            code_number TEXT,
            item_name TEXT,
            character_img_url TEXT,
            character_name TEXT,
            character_parameter JSONB,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        """
        
        cursor.execute(create_operations_table)
        print("âœ… user_operationsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ")
        
        # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ï¼ˆæ¤œç´¢æ€§èƒ½å‘ä¸Šï¼‰
        create_indexes = [
            "CREATE INDEX IF NOT EXISTS idx_users_mail ON users(mail_address);",
            "CREATE INDEX IF NOT EXISTS idx_operations_user_id ON user_operations(user_id);",
            "CREATE INDEX IF NOT EXISTS idx_operations_code ON user_operations(code_number);",
            "CREATE INDEX IF NOT EXISTS idx_operations_created_at ON user_operations(created_at);"
        ]
        
        for index_sql in create_indexes:
            cursor.execute(index_sql)
        
        print("âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸ")
        
        # Row Level Security (RLS) ã‚’æœ‰åŠ¹åŒ–
        rls_commands = [
            "ALTER TABLE users ENABLE ROW LEVEL SECURITY;",
            "ALTER TABLE user_operations ENABLE ROW LEVEL SECURITY;"
        ]
        
        for rls_sql in rls_commands:
            cursor.execute(rls_sql)
        
        print("âœ… Row Level Security (RLS) ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ")
        
        # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        conn.commit()
        
        print("\nğŸ‰ å…¨ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼")
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
        cursor.execute("""
            SELECT table_name, column_name, data_type, is_nullable
            FROM information_schema.columns 
            WHERE table_name IN ('users', 'user_operations')
            ORDER BY table_name, ordinal_position;
        """)
        
        results = cursor.fetchall()
        
        print("\nğŸ“‹ ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ :")
        current_table = ""
        for row in results:
            table_name, column_name, data_type, is_nullable = row
            if table_name != current_table:
                print(f"\nğŸ“„ {table_name} ãƒ†ãƒ¼ãƒ–ãƒ«:")
                current_table = table_name
            nullable = "NULLå¯" if is_nullable == "YES" else "NOT NULL"
            print(f"  - {column_name}: {data_type} ({nullable})")
        
        return True
        
    except psycopg2.Error as e:
        print(f"âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: {e}")
        return False
    except Exception as e:
        print(f"âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {e}")
        return False
    finally:
        if 'cursor' in locals():
            cursor.close()
        if 'conn' in locals():
            conn.close()
        print("\nğŸ”Œ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’é–‰ã˜ã¾ã—ãŸ")

def verify_tables():
    """
    ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªã™ã‚‹
    """
    print("\nğŸ” ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã®ç¢ºèªã‚’è¡Œã„ã¾ã™...")
    
    # åŒã˜æ¥ç¶šå‡¦ç†ï¼ˆç°¡ç•¥åŒ–ï¼‰
    supabase_url = os.getenv("SUPABASE_URL")
    db_password = os.getenv("SUPABASE_DB_PASSWORD")
    host = supabase_url.replace("https://", "").replace("http://", "")
    
    try:
        conn = psycopg2.connect(
            host=host,
            database="postgres", 
            user="postgres",
            password=db_password,
            port="5432"
        )
        cursor = conn.cursor()
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
        cursor.execute("""
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' 
            AND table_name IN ('users', 'user_operations');
        """)
        
        existing_tables = [row[0] for row in cursor.fetchall()]
        
        print(f"âœ… å­˜åœ¨ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«: {existing_tables}")
        
        if len(existing_tables) == 2:
            print("ğŸ¯ å…¨ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£å¸¸ã«å­˜åœ¨ã—ã¦ã„ã¾ã™ï¼")
        else:
            print("âš ï¸  ä¸€éƒ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            
    except Exception as e:
        print(f"âŒ ç¢ºèªã‚¨ãƒ©ãƒ¼: {e}")
    finally:
        if 'cursor' in locals():
            cursor.close()
        if 'conn' in locals():
            conn.close()

if __name__ == "__main__":
    print("ğŸš€ Supabase ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é–‹å§‹ã—ã¾ã™")
    print("=" * 50)
    
    success = create_tables()
    
    if success:
        verify_tables()
        print("\nâœ¨ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼")
        print("   ã“ã‚Œã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚")
    else:
        print("\nâŒ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
        print("   .envãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")