import os
from supabase import create_client, Client
from dotenv import load_dotenv

# ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
load_dotenv()

def create_tables_with_supabase_sdk():
    """
    Supabase Python SDKã‚’ä½¿ç”¨ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹
    """
    
    # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
    supabase_url = os.getenv("SUPABASE_URL")
    supabase_anon_key = os.getenv("SUPABASE_ANON_KEY")
    
    if not supabase_url or not supabase_anon_key:
        print("âŒ ã‚¨ãƒ©ãƒ¼: .envãƒ•ã‚¡ã‚¤ãƒ«ã«SUPABASE_URLã¨SUPABASE_ANON_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return False
    
    try:
        # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
        supabase: Client = create_client(supabase_url, supabase_anon_key)
        print("ğŸ”Œ Supabaseã«æ¥ç¶šã—ã¾ã—ãŸ")
        
        # SQLæ–‡ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®RPCé–¢æ•°å‘¼ã³å‡ºã—
        # æ³¨æ„: ã“ã‚Œã«ã¯Supabaseä¸Šã§SQLå®Ÿè¡Œæ¨©é™ãŒå¿…è¦ã§ã™
        
        # 1. User Base Tableã®ä½œæˆ
        create_users_sql = """
        CREATE TABLE IF NOT EXISTS users (
            user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
            mail_address TEXT UNIQUE NOT NULL,
            user_name TEXT,
            location TEXT,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        """
        
        # 2. User_OperationsDBãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
        create_operations_sql = """
        CREATE TABLE IF NOT EXISTS user_operations (
            id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
            user_id UUID REFERENCES users(user_id),
            code_number TEXT,
            item_name TEXT,
            character_img_url TEXT,
            character_name TEXT,
            character_parameter JSONB,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        """
        
        # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
        create_indexes_sql = """
        CREATE INDEX IF NOT EXISTS idx_users_mail ON users(mail_address);
        CREATE INDEX IF NOT EXISTS idx_operations_user_id ON user_operations(user_id);
        CREATE INDEX IF NOT EXISTS idx_operations_code ON user_operations(code_number);
        CREATE INDEX IF NOT EXISTS idx_operations_created_at ON user_operations(created_at);
        """
        
        # RLSæœ‰åŠ¹åŒ–
        enable_rls_sql = """
        ALTER TABLE users ENABLE ROW LEVEL SECURITY;
        ALTER TABLE user_operations ENABLE ROW LEVEL SECURITY;
        """
        
        # å…¨ã¦ã®SQLæ–‡ã‚’çµåˆ
        full_sql = f"""
        {create_users_sql}
        {create_operations_sql}
        {create_indexes_sql}
        {enable_rls_sql}
        """
        
        # SQLå®Ÿè¡Œï¼ˆRPCã¾ãŸã¯postgrestçµŒç”±ï¼‰
        try:
            # ã¾ãšã¯ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
            users_check = supabase.table('users').select('*').limit(1).execute()
            print("âœ… usersãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰")
        except Exception as e:
            print(f"â„¹ï¸  usersãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª: {str(e)}")
            print("   â†’ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚SQL Editorã§ã®ä½œæˆãŒå¿…è¦ã§ã™ã€‚")
        
        try:
            operations_check = supabase.table('user_operations').select('*').limit(1).execute()
            print("âœ… user_operationsãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰")
        except Exception as e:
            print(f"â„¹ï¸  user_operationsãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª: {str(e)}")
            print("   â†’ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚SQL Editorã§ã®ä½œæˆãŒå¿…è¦ã§ã™ã€‚")
        
        print("\nğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆSQLæ–‡:")
        print("=" * 60)
        print(full_sql)
        print("=" * 60)
        print("\nğŸ’¡ æ‰‹å‹•ã§ã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæ‰‹é †:")
        print("1. Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > SQL Editor ã‚’é–‹ã")
        print("2. ä¸Šè¨˜ã®SQLæ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè¡Œ")
        print("3. å®Ÿè¡Œå¾Œã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†å®Ÿè¡Œã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª")
        
        return True
        
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
        return False

def verify_tables_with_sdk():
    """
    Supabase SDKã‚’ä½¿ç”¨ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
    """
    supabase_url = os.getenv("SUPABASE_URL")
    supabase_anon_key = os.getenv("SUPABASE_ANON_KEY")
    
    try:
        supabase: Client = create_client(supabase_url, supabase_anon_key)
        
        print("\nğŸ” ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªã‚’å®Ÿè¡Œä¸­...")
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
        tables_status = {}
        
        # usersãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
        try:
            result = supabase.table('users').select('user_id').limit(1).execute()
            tables_status['users'] = "âœ… å­˜åœ¨"
            print(f"âœ… usersãƒ†ãƒ¼ãƒ–ãƒ«: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½")
        except Exception as e:
            tables_status['users'] = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
            print(f"âŒ usersãƒ†ãƒ¼ãƒ–ãƒ«: {str(e)}")
        
        # user_operationsãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
        try:
            result = supabase.table('user_operations').select('id').limit(1).execute()
            tables_status['user_operations'] = "âœ… å­˜åœ¨"
            print(f"âœ… user_operationsãƒ†ãƒ¼ãƒ–ãƒ«: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½")
        except Exception as e:
            tables_status['user_operations'] = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
            print(f"âŒ user_operationsãƒ†ãƒ¼ãƒ–ãƒ«: {str(e)}")
        
        return tables_status
        
    except Exception as e:
        print(f"âŒ ç¢ºèªã‚¨ãƒ©ãƒ¼: {e}")
        return {}

if __name__ == "__main__":
    print("ğŸš€ Supabase ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆSDKç‰ˆï¼‰ã‚’é–‹å§‹ã—ã¾ã™")
    print("=" * 50)
    
    success = create_tables_with_supabase_sdk()
    
    if success:
        tables_status = verify_tables_with_sdk()
        
        if all("âœ…" in status for status in tables_status.values()):
            print("\nğŸ‰ å…¨ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£å¸¸ã«ä½œæˆãƒ»ç¢ºèªã•ã‚Œã¾ã—ãŸï¼")
        else:
            print("\nâš ï¸  ä¸€éƒ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ä¸Šè¨˜ã®SQLæ–‡ã‚’æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")
    else:
        print("\nâŒ å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")